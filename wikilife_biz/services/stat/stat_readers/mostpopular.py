# coding=utf-8

from wikilife_biz.services.stat.stat_readers.base_stat_reader import BaseStatReader
from wikilife_utils.date_utils import DateUtils
from operator import itemgetter


class BaseMostPopularReader(BaseStatReader):

    NODE_IDS = None

    def read_stat(self, user_id=None):
        nodes = []
        node_count_map = {}
        total = 0
        to_date = DateUtils.get_datetime_utc()
        from_date = DateUtils.add_months(to_date, -12)

        for item in self._daos.aggregation_node_dao.count_logged_nodes(node_ids=self.NODE_IDS, user_id=user_id, from_date=from_date, to_date=to_date):
            node_count_map[int(item["_id"])] = item["value"]
            total += item["value"]

        node_ids = node_count_map.keys() if user_id else self.NODE_IDS
        meta_nodes = self._daos.meta_dao.get_nodes_by_ids(node_ids)

        if total==0:
            total = 1

        for n in meta_nodes:
            count = node_count_map[n._id] if n._id in node_count_map else 0  
            per = round(count*100.0/total, 4)
            nodes.append({"id": n._id, "name": n.name, "percentage": per})

        nodes.sort(key=itemgetter("percentage"), reverse=True)

        return {
         "data": nodes
        }


class ComplaintsReader(BaseMostPopularReader):
    NODE_IDS = [2510,2512,2514,2516,2518,2520,2522,2524,2528,2530,2532,2536,2538,2540,2542,2544,2550,2552,2554,2556,2562,2564,2567,2570,2573,2576,2579,2582,2585,2588,2591,2594,2597,2600,2603,2606,2608,2611,2614,2617,2620,2623,2626,2629,2632,2635,2638,2641,2644,2647,2650,2652,2654,2656,2671,2673,2675,2678,2680,2682,2684,2686,2691,2694,2696,2700,2702,2706,2708,2710,2712,2714,2716,2718,2720,2722,2724,2726,2728,2730,2732,2734,2736,2740,2742,2744,2746,2748,2750,2752,2760,2762,2764,2767,2770,2780,2782,2784,2786,2788,2790,2792,2796,2799,2804,2806,2808,2810,2812,2818,2820,2824,2826,2833,2838,2841,2847,2851,2857,2859,2861,2863,2868,2871,2873,2875,2880,2882,2884,2888,2894,2896,2902,2904,2906,2908,2910,2912,2914,2916,2918,2920,2922,2924,2926,2928,2930,2932,2934,2936,2938,2940,2942,2944,2946,2948,2950,2953,2962,2964,2966,2968,2973,2975,2977,2980,2982,2984,2987,2990,2992,2998,3004,3010,3012,3036,3040,3044,3049,3060,3064,3066,3069,3074,3076,3079,3081,3083,3085,3087,3089,3094,3096,3098,3109,3111,3113,3115,3121,3128,3130,3132,3135,3137,3139,3141,3146,3148,3150,3153,3155,3157,3160,3162,3164,3170,3174,3176,3178,3180,3182,3185,3187,3189,3191,3193,3195,3197,3200,3203,3206,3209,3212,3214,3216,3218,3220,3222,3224,3226,3228,3230,3236,3242,3244,3246,3251,3255,3259,3272,3274,3279,3281,3285,3287,3289,3293,3296,3299,3302,3307,3312,3316,3318,3320,3322,3324,3326,3330,3332,3338,3340,3344,3346,3350,3352,3355,3359,3361,3363,3368,3370,3372,3377,3381,3383,3385,3387,3389,3391,3393,3395,3397,3399,3401,3407,3409,3411,3413,3415,3418,3423,3427,3429,3434,3436,3438,3440,3442,3444,3446,3449,3451,3453,3455,3459,3461,3464,3467,3469,3474,3476,3478,3480,3482,3485,3488,3491,3493,3495,3497,3499,3503,3505,3507,3509,3511,3513,3516,3519,3521,3523,3525,3527,3530,3536,3538,3540,3542,3544,3546,3549,3556,3558,3566,3568,3570,3572,3574,3578,3580,3584,3586,3588,3590,3592,3596,3598,3600,3602,3604,3606,3608,3611,3613,3615,3617,3621,3623,3625,3627,3631,3633,3635,3637,3639,3641,3643,3645,3649,3651,3653,3655,3657,3660,3663,3666,3668,3670,3672,3674,3676,3678,3680,3688,3690,3692,3694,3696,3698,3700,3702,3708,3712,3719,3721,3723,3725,3727,3729,3732,3734,3736,3738,3740,3742,3744,3746,3749,3751,3753,3758,3760,3762,3764,3766,3768,3772,3774,3776,3778,3780,3782,3784,3786,3788,3790,3792,3794,3796,3798,3800,3804,3806,3808,3810,3812,3814,3816,3818,3820,3822,3830,3832,3834,3838,3844,3846,3848,3850,3852,3854,3856,3858,3860,3865,3867,3869,3871,3873,3875,3877,3880,3882,3885,3887,3889,3891,3893,3895,3897,3909,3911,3913,3917,3919,3927,3929,3933,3935]


class ConditionsReader(BaseMostPopularReader):
    NODE_IDS = [3194, 3196, 3199, 3198, 3202, 26677, 3201, 26779, 26779, 38883, 41019, 27155, 274351, 27179, 27179, 37202, 3205, 27217, 27283, 34644, 33389, 27365, 27453, 27457, 27459, 27461, 29343, 27573, 27615, 40339, 27667, 27845, 33093, 33405, 28167, 28169, 28421, 33423, 33427, 28201, 33557, 28469, 33455, 28781, 38210, 40961, 28643, 28645, 28325, 28881, 28921, 28963, 28965, 28967, 35736, 33467, 29073, 39755, 39061, 27593, 29737, 3204, 30021, 40993, 30101, 30881, 30945, 33679, 31211, 34560, 29999, 30391, 33711, 34055, 31595, 37866, 31727, 3208, 28801, 27215, 33745, 3182, 26911, 35734, 31933, 28441, 30915, 30413, 31991, 31079, 38927, 3217, 32075, 30513, 40915, 32581, 30007, 32171, 36940, 33135, 33487, 33607, 31945, 3207, 37422, 38218, 41357, 33431, 40395, 33299, 33641, 28687, 35290, 34558, 35294, 37092, 33229, 33667, 34662, 34704, 34708, 34764, 35222, 35224, 35254, 36770, 35354, 35438, 33781, 3221, 33675, 33939, 38264, 38290, 33971, 38646, 3223, 38897, 33797, 38981, 39017, 39087, 36154, 39093, 39095, 39097, 3225, 33719, 3210, 3213, 37242, 39443, 39437, 39439, 39441, 39457, 34554, 39461, 34550, 37820, 40701, 40695, 40697, 40699, 39509, 33625, 40403, 39929, 31017, 36706, 34071, 33817, 40565, 3227, 3229, 35296, 29427, 35300, 35302, 35304, 40873, 40887, 33825, 33827, 41241, 3215, 41325, 28283, 29929, 37668, 29043, 30867, 39471, 273780, 31705]
    CATEG_NODE_IDS = {28167: [], 28169: [], 28687: [], 27667: [], 35354: [], 29737: [], 27179: [], 39471: [], 26677: [], 38981: [], 36940: [], 27215: [], 27217: [], 39509: [], 39017: [], 28781: [], 3182: [], 27155: [], 40565: [], 3194: [33389, 33405, 33423, 33427, 33557, 33455, 33467, 33679, 33711, 34055, 33745, 32075, 33135, 33487, 33607, 33431, 33299, 33641, 33667, 34704, 34764, 35222, 33781, 33675, 33939, 33971, 33797, 3225, 33719, 33625, 34071, 33817, 33825, 33827], 28283: [], 3196: [37202, 27573, 28201, 40961, 28881, 39061, 30881, 38927], 3198: [27179, 27365, 27453, 27457, 27459, 27461, 29343, 27615, 40339, 27845, 28469, 28645, 27593, 30101, 30945, 34560, 26911, 35734, 31933, 28441, 30915, 31079, 38927, 37422, 35290, 34558, 35294, 36770, 35438, 3221, 38264, 3223, 39087, 36154, 39093, 39095, 39097, 37242, 39443, 39437, 39439, 39441, 39457, 34554, 39461, 34550, 37820, 40701, 40695, 40697, 40699, 3227, 3229, 35296, 29427, 35300, 35302, 35304, 41241, 30867], 3199: [40993, 32581, 35224], 3201: [], 3202: [41019, 3217], 3204: [], 3205: [], 3207: [], 3208: [], 3210: [], 3213: [], 3215: [], 27283: [], 26779: [], 28325: [], 30391: [], 31945: [], 30413: [], 37092: [], 29929: [], 40915: [], 38646: [], 31991: [], 28921: [], 28421: [], 28801: [], 28963: [], 37668: [], 28965: [], 28967: [], 31017: [], 29999: [], 30513: [], 30007: [], 38210: [], 33093: [], 38218: [], 39755: [], 38883: [], 34644: [], 36706: [], 34662: [], 31595: [], 41325: [], 29043: [], 273780: [], 41357: [], 29073: [], 38290: [], 34708: [], 35736: [], 30021: [], 40873: [], 32171: [], 274351: [], 35254: [], 40887: [], 40395: [], 33229: [], 40403: [], 31705: [], 28643: [], 37866: [], 31211: [], 31727: [], 38897: [], 39929: []}

    def read_stat(self, user_id=None):
        r = BaseMostPopularReader.read_stat(self, user_id=user_id)

        for node in r["data"]:
            node["types"] = []

            if node["id"] in self.CATEG_NODE_IDS:
                sub_node_ids = self.CATEG_NODE_IDS[node["id"]]
                meta_nodes = self._daos.meta_dao.get_nodes_by_ids(sub_node_ids)

                for meta_node in meta_nodes:
                    node["types"].append({"id": meta_node._id, "name": meta_node.name})

        return r


class MoodsReader(BaseMostPopularReader):
    NODE_IDS = [275105, 275108, 275112, 275115, 275118, 275121, 275124, 275128, 275131, 275134, 275137, 275140, 275144, 275147, 275149, 275152, 275155, 275158, 275161, 275164, 275167, 275170, 275173, 275176, 275179, 275182, 275185, 275188, 275191, 275194, 275197, 275200, 275203, 275206, 275209, 275212, 275215, 275218, 275221, 275224, 275227, 275230, 275233, 275236, 275239, 275242, 275245, 275248, 275251, 275254, 275257, 275261, 275265, 275268, 275271, 275274, 275277, 275280, 275283, 275286, 275289, 275292, 275296, 275299, 275302, 275305, 275308, 275311, 275314, 275317, 275320, 275323, 275326, 275329, 275332, 275335, 275338, 275341, 275344, 275347, 275350, 275353, 275356, 275360, 275363, 275366, 275370, 275373, 275375, 275378, 275381, 275384, 275387, 275390, 275393, 275396, 275399, 275402, 275405, 275408, 275411, 275414, 275417, 275420, 275423, 275426, 275429, 275432, 275435, 275438, 275441, 275444, 275447, 275450, 275453, 275455, 275458, 275461, 275464, 275467, 275470, 275473, 275476, 275480, 275483, 275487, 275491, 275494, 275497, 275500, 275503, 275506, 275509, 275512, 275515, 275518, 275521, 275524, 275527, 275530, 275533, 275536, 275539, 275542, 275545, 275548, 275551, 275555, 275558, 275561, 275564, 275567, 275570, 275573, 275576, 275580, 275583, 275586, 275590, 275593, 275596, 275599, 275602, 275605, 275608, 275612, 275615, 275618, 275621, 275624, 275627, 275631, 275634, 275637, 275641, 275644]
